<html>
  <head>
    <!--
      required editor styles
    -->
    <link rel="stylesheet" href="https://unpkg.com/@bpmn-io/form-js@1.15.3/dist/assets/form-js.css">
    <link rel="stylesheet" href="https://unpkg.com/@bpmn-io/form-js@1.15.3/dist/assets/form-js-editor.css">

    <style>
      body, html {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
      }

      #form {
        max-width: 100%;
      }

      #save-button {
        position: fixed;
        top: 0;
        right: 0;
        width: 36px;
        height: 36px;
        background-color: #c3c0c0;
        cursor: pointer;
        border: 1px solid #767676;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        color:white;
      }

      #save-button:hover {
        color: #0086e6;
      }
    </style>
  </head>

  <body>
    <div id="form"></div>

    <button id="save-button" title="Export Form" style="display: flex; align-items: center; justify-content: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 3v14m0 0-5-5m5 5 5-5M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <!--
      add your form schema to this script tag
      alternatively, load it asynchronously from anywhere
    -->
    <!--
    <script type="application/form-schema">
{"executionPlatform":"Camunda Cloud","executionPlatformVersion":"8.7.0","exporter":{"name":"Camunda Web Modeler","version":"b05b990"},"schemaVersion":18,"id":"Form_DefineScopeAndTermsWithCustomer-0s8syo5","components": [
    {
      "text": "### Business Travel Request",
      "label": "Text view",
      "type": "text",
      "layout": {
        "row": "Row_1ski79f",
        "columns": null
      },
      "id": "Field_0wrpny7"
    },
    {
      "label": "Destination",
      "type": "textfield",
      "layout": {
        "row": "Row_1wqhz20",
        "columns": null
      },
      "id": "Field_1t9i9fo",
      "key": "travelDestination",
      "description": "Customer's location",
      "defaultValue": "Paris"
    },
    {
      "subtype": "date",
      "dateLabel": "Date",
      "label": "Date time",
      "type": "datetime",
      "layout": {
        "row": "Row_0w2o8c1",
        "columns": null
      },
      "id": "Field_0zynihr",
      "key": "travelDate",
      "description": "Date selected by customer"
    },
    {
      "label": "Trip required?",
      "type": "checkbox",
      "layout": {
        "row": "Row_16f2ya9",
        "columns": null
      },
      "id": "Field_04okdj6",
      "key": "tripRequired",
      "description": "If the issue can only be solved onsite",
      "defaultValue": true
    },
    {
      "label": "Notes",
      "type": "textarea",
      "layout": {
        "row": "Row_0ggqifn",
        "columns": null
      },
      "id": "Field_07kchtx",
      "key": "notes"
    }
  ],"type":"default"}
    </script>
  -->

    <!-- required editor script -->
    <script src="https://unpkg.com/@bpmn-io/form-js@1.15.3/dist/form-editor.umd.js"></script>

    <script>
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function loadSchema() {
        const schemaUrl = getQueryParam('json');
        if (schemaUrl) {
          try {
            const response = await fetch(schemaUrl);
            if (!response.ok) throw new Error('Network response was not ok');
            const text = await response.text();
            return JSON.parse(text);
          } catch (e) {
            alert('Failed to load schema from URL: ' + e.message);
            return {};
          }
        } else {
          const embedded = document.querySelector('[type="application/form-schema"]');
          if (embedded) {
            return JSON.parse(embedded.textContent);
          } else {
            alert('No form schema found. Please provide a ?json= URL or embed a schema.');
            return {};
          }
        }
      }

      function getFormName(schema) {
        // Try to use the schema's name or id property, fallback to 'form'
        if (schema && schema.name) {
          return schema.name.replace(/[\\/:*?"<>|]+/g, '_');
        }
        if (schema && schema.id) {
          return schema.id.replace(/[\\/:*?"<>|]+/g, '_');
        }
        return 'form';
      }

      function download(filename, text) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      let formEditorInstance;
      let loadedSchema;

      const container = document.querySelector('#form');

      loadSchema().then(schema => {
        loadedSchema = schema;
        formEditorInstance = new window.FormEditor.FormEditor({
          container,
          schema
        });
      });

      document.getElementById('save-button').onclick = function() {
        if (!formEditorInstance) return;
        const schema = formEditorInstance.getSchema();
        const name = getFormName(schema || loadedSchema);
        download(name + '.json', JSON.stringify(schema, null, 2));
      };
    </script>  
  </body>
</html>